/*  Matouš Skála.
 License: The game soundtrack (composed by me) and the source code is licensed under Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License
 publish in Wed Feb 17 2016 20:07:48*/
!function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}();var Utils={};Utils.comparePositions=function(a,b){return a.x==b.x&&a.y==b.y},Utils.convertToEntityPosition=function(a){var b={};return b.x=Math.round(a.x/gGameEngine.tileSize),b.y=Math.round(a.y/gGameEngine.tileSize),b},Utils.convertToBitmapPosition=function(a){var b={};return b.x=a.x*gGameEngine.tileSize,b.y=a.y*gGameEngine.tileSize,b},Utils.removeFromArray=function(a,b){for(var c=0;c<a.length;c++)b==a[c]&&a.splice(c,1);return a},Entity=Class.extend({init:function(){},update:function(){}}),Player=Entity.extend({id:0,velocity:2,bombsMax:1,bombStrength:1,position:{},size:{w:48,h:48},bmp:null,alive:!0,bombs:[],controls:{up:"up",left:"left",down:"down",right:"right",bomb:"bomb"},escapeBomb:null,deadTimer:0,init:function(a,b,c){c&&(this.id=c),b&&(this.controls=b);var d=gGameEngine.playerBoyImg;this instanceof Bot||(d=0==this.id?gGameEngine.playerGirlImg:gGameEngine.playerGirl2Img);var e=new createjs.SpriteSheet({images:[d],frames:{width:this.size.w,height:this.size.h,regX:10,regY:12},animations:{idle:[0,0,"idle"],down:[0,3,"down",.1],left:[4,7,"left",.1],up:[8,11,"up",.1],right:[12,15,"right",.1],dead:[16,16,"dead",.1]}});this.bmp=new createjs.Sprite(e),this.position=a;var f=Utils.convertToBitmapPosition(a);this.bmp.x=f.x,this.bmp.y=f.y,gGameEngine.stage.addChild(this.bmp),this.bombs=[],this.setBombsListener()},setBombsListener:function(){if(!(this instanceof Bot)){var a=this;gInputEngine.addListener(this.controls.bomb,function(){for(var b=0;b<gGameEngine.bombs.length;b++){var c=gGameEngine.bombs[b];if(Utils.comparePositions(c.position,a.position))return}for(var d=0,b=0;b<a.bombs.length;b++)a.bombs[b].exploded||d++;if(d<a.bombsMax){var c=new Bomb(a.position,a.bombStrength);gGameEngine.stage.addChild(c.bmp),a.bombs.push(c),gGameEngine.bombs.push(c),c.setExplodeListener(function(){Utils.removeFromArray(a.bombs,c)})}})}},update:function(){if(this.alive&&!gGameEngine.menu.visible){var a={x:this.bmp.x,y:this.bmp.y},b=0,c=0;if(gInputEngine.actions[this.controls.up]?(this.animate("up"),a.y-=this.velocity,c=-1):gInputEngine.actions[this.controls.down]?(this.animate("down"),a.y+=this.velocity,c=1):gInputEngine.actions[this.controls.left]?(this.animate("left"),a.x-=this.velocity,b=-1):gInputEngine.actions[this.controls.right]?(this.animate("right"),a.x+=this.velocity,b=1):this.animate("idle"),(a.x!=this.bmp.x||a.y!=this.bmp.y)&&!this.detectBombCollision(a))if(this.detectWallCollision(a)){var d=this.getCornerFix(b,c);if(d){var e=0,f=0;b?f=d.y-this.bmp.y>0?1:-1:e=d.x-this.bmp.x>0?1:-1,this.bmp.x+=e*this.velocity,this.bmp.y+=f*this.velocity,this.updatePosition()}}else this.bmp.x=a.x,this.bmp.y=a.y,this.updatePosition();this.detectFireCollision()&&this.die(),this.handleBonusCollision()}},getCornerFix:function(a,b){var c=30,d={},e={x:this.position.x+b,y:this.position.y+a},f=Utils.convertToBitmapPosition(e),g={x:this.position.x-b,y:this.position.y-a},h=Utils.convertToBitmapPosition(g);return"grass"==gGameEngine.getTileMaterial({x:this.position.x+a,y:this.position.y+b})?d=this.position:"grass"==gGameEngine.getTileMaterial(e)&&Math.abs(this.bmp.y-f.y)<c&&Math.abs(this.bmp.x-f.x)<c?"grass"==gGameEngine.getTileMaterial({x:e.x+a,y:e.y+b})&&(d=e):"grass"==gGameEngine.getTileMaterial(g)&&Math.abs(this.bmp.y-h.y)<c&&Math.abs(this.bmp.x-h.x)<c&&"grass"==gGameEngine.getTileMaterial({x:g.x+a,y:g.y+b})&&(d=g),d.x&&"grass"==gGameEngine.getTileMaterial(d)?Utils.convertToBitmapPosition(d):void 0},updatePosition:function(){this.position=Utils.convertToEntityPosition(this.bmp)},detectWallCollision:function(a){var b={};b.left=a.x,b.top=a.y,b.right=b.left+this.size.w,b.bottom=b.top+this.size.h;for(var c=gGameEngine.tiles,d=0;d<c.length;d++){var e=c[d].position,f={};if(f.left=e.x*gGameEngine.tileSize+25,f.top=e.y*gGameEngine.tileSize+20,f.right=f.left+gGameEngine.tileSize-30,f.bottom=f.top+gGameEngine.tileSize-30,gGameEngine.intersectRect(b,f))return!0}return!1},detectBombCollision:function(a){for(var b=Utils.convertToEntityPosition(a),c=0;c<gGameEngine.bombs.length;c++){var d=gGameEngine.bombs[c];if(d.position.x==b.x&&d.position.y==b.y)return d==this.escapeBomb?!1:!0}return this.escapeBomb&&(this.escapeBomb=null),!1},detectFireCollision:function(){for(var a=gGameEngine.bombs,b=0;b<a.length;b++)for(var c=a[b],d=0;d<c.fires.length;d++){var e=c.fires[d],f=c.exploded&&e.position.x==this.position.x&&e.position.y==this.position.y;if(f)return!0}return!1},handleBonusCollision:function(){for(var a=0;a<gGameEngine.bonuses.length;a++){var b=gGameEngine.bonuses[a];Utils.comparePositions(b.position,this.position)&&(this.applyBonus(b),b.destroy())}},applyBonus:function(a){"speed"==a.type?this.velocity+=.8:"bomb"==a.type?this.bombsMax++:"fire"==a.type&&this.bombStrength++},animate:function(a){this.bmp.currentAnimation&&-1!==this.bmp.currentAnimation.indexOf(a)||this.bmp.gotoAndPlay(a)},die:function(){this.alive=!1,1==gGameEngine.countPlayersAlive()&&2==gGameEngine.playersCount?gGameEngine.gameOver("win"):0==gGameEngine.countPlayersAlive()&&gGameEngine.gameOver("lose"),this.bmp.gotoAndPlay("dead"),this.fade()},fade:function(){var a=0,b=this.bmp,c=setInterval(function(){a++,a>30&&(b.alpha-=.05),b.alpha<=0&&clearInterval(c)},30)}}),Bot=Player.extend({direction:"up",lastDirection:"",excludeDirections:[],dirX:0,dirY:-1,previousPosition:{},targetPosition:{},targetBitmapPosition:{},bombsMax:1,wait:!1,startTimerMax:60,startTimer:0,started:!1,init:function(a){this._super(a),this.findTargetPosition(),this.startTimerMax=60*Math.random()},update:function(){return this.alive?(this.wait=!1,!this.started&&this.startTimer<this.startTimerMax&&(this.startTimer++,this.startTimer>=this.startTimerMax&&(this.started=!0),this.animate("idle"),this.wait=!0),this.targetBitmapPosition.x==this.bmp.x&&this.targetBitmapPosition.y==this.bmp.y&&((this.getNearWood()||this.wantKillPlayer())&&this.plantBomb(),this.bombs.length&&this.isSafe(this.position)&&(this.wait=!0),this.wait||this.findTargetPosition()),this.wait||this.moveToTargetPosition(),this.handleBonusCollision(),void(this.detectFireCollision()&&this.die())):void this.fade()},findTargetPosition:function(){var a={x:this.position.x,y:this.position.y};a.x+=this.dirX,a.y+=this.dirY;var b=this.getPossibleTargets();if(b.length>1)for(var c=this.getPreviousPosition(),d=0;d<b.length;d++){var e=b[d];e.x==c.x&&e.y==c.y&&b.splice(d,1)}this.targetPosition=this.getRandomTarget(b),this.targetPosition&&this.targetPosition.x&&(this.loadTargetPosition(this.targetPosition),this.targetBitmapPosition=Utils.convertToBitmapPosition(this.targetPosition))},moveToTargetPosition:function(){this.animate(this.direction);var a=this.velocity,b=Math.abs(this.targetBitmapPosition.x-this.bmp.x),c=Math.abs(this.targetBitmapPosition.y-this.bmp.y);b>0&&b<this.velocity?a=b:c>0&&c<this.velocity&&(a=c);var d={x:this.bmp.x+this.dirX*a,y:this.bmp.y+this.dirY*a};this.detectWallCollision(d)||(this.bmp.x=d.x,this.bmp.y=d.y),this.updatePosition()},getPossibleTargets:function(){for(var a=[],b=0;4>b;b++){var c,d;0==b?(c=1,d=0):1==b?(c=-1,d=0):2==b?(c=0,d=1):3==b&&(c=0,d=-1);var e={x:this.position.x+c,y:this.position.y+d};"grass"!=gGameEngine.getTileMaterial(e)||this.hasBomb(e)||a.push(e)}for(var f=[],b=0;b<a.length;b++){var g=a[b];this.isSafe(g)&&f.push(g)}var h=Math.random()>.3;return f.length>0&&h?f:a},loadTargetPosition:function(a){this.dirX=a.x-this.position.x,this.dirY=a.y-this.position.y,1==this.dirX&&0==this.dirY?this.direction="right":-1==this.dirX&&0==this.dirY?this.direction="left":0==this.dirX&&1==this.dirY?this.direction="down":0==this.dirX&&-1==this.dirY&&(this.direction="up")},getPreviousPosition:function(){var a={x:this.targetPosition.x,y:this.targetPosition.y};return a.x-=this.dirX,a.y-=this.dirY,a},getRandomTarget:function(a){return a[Math.floor(Math.random()*a.length)]},applyBonus:function(a){this._super(a),this.bombsMax=1},die:function(){this._super();for(var a=!1,b=[],c=0;c<gGameEngine.bots.length;c++)b.push(gGameEngine.bots[c]);for(var c=0;c<b.length;c++){var d=b[c];d==this&&gGameEngine.bots.splice(c,1),d.alive&&(a=!0)}a||1!=gGameEngine.countPlayersAlive()||gGameEngine.gameOver("win")},getNearWood:function(){for(var a=0;4>a;a++){var b,c;0==a?(b=1,c=0):1==a?(b=-1,c=0):2==a?(b=0,c=1):3==a&&(b=0,c=-1);var d={x:this.position.x+b,y:this.position.y+c};if("wood"==gGameEngine.getTileMaterial(d))return gGameEngine.getTile(d)}},wantKillPlayer:function(){for(var a=!1,b=0;4>b;b++){var c,d;0==b?(c=1,d=0):1==b?(c=-1,d=0):2==b?(c=0,d=1):3==b&&(c=0,d=-1);for(var e={x:this.position.x+c,y:this.position.y+d},f=0;f<gGameEngine.players.length;f++){var g=gGameEngine.players[f];if(g.alive&&Utils.comparePositions(g.position,e)){a=!0;break}}}var h=Math.random()>.5;return a&&h?!0:void 0},plantBomb:function(){for(var a=0;a<gGameEngine.bombs.length;a++){var b=gGameEngine.bombs[a];if(Utils.comparePositions(b.position,this.position))return}if(this.bombs.length<this.bombsMax){var b=new Bomb(this.position,this.bombStrength);gGameEngine.stage.addChild(b.bmp),this.bombs.push(b),gGameEngine.bombs.push(b);var c=this;b.setExplodeListener(function(){Utils.removeFromArray(c.bombs,b),c.wait=!1})}},isSafe:function(a){for(var b=0;b<gGameEngine.bombs.length;b++)for(var c=gGameEngine.bombs[b],d=c.getDangerPositions(),e=0;e<d.length;e++){var f=d[e];if(Utils.comparePositions(f,a))return!1}return!0},hasBomb:function(a){for(var b=0;b<gGameEngine.bombs.length;b++){var c=gGameEngine.bombs[b];if(Utils.comparePositions(c.position,a))return!0}return!1}}),Bonus=Entity.extend({types:["speed","bomb","fire"],type:"",position:{},bmp:null,init:function(a,b){this.type=this.types[b],this.position=a,this.bmp=new createjs.Bitmap(gGameEngine.bonusesImg);var c=Utils.convertToBitmapPosition(a);this.bmp.x=c.x,this.bmp.y=c.y,this.bmp.sourceRect=new createjs.Rectangle(32*b,0,32,32),gGameEngine.stage.addChild(this.bmp)},destroy:function(){gGameEngine.stage.removeChild(this.bmp),Utils.removeFromArray(gGameEngine.bonuses,this)}}),Tile=Entity.extend({position:{},size:{w:32,h:32},bmp:null,material:"",init:function(a,b){this.material=a,this.position=b;var c;"grass"==a?c=gGameEngine.tilesImgs.grass:"wall"==a?c=gGameEngine.tilesImgs.wall:"wood"==a&&(c=gGameEngine.tilesImgs.wood),this.bmp=new createjs.Bitmap(c);var d=Utils.convertToBitmapPosition(b);this.bmp.x=d.x,this.bmp.y=d.y},update:function(){},remove:function(){gGameEngine.stage.removeChild(this.bmp);for(var a=0;a<gGameEngine.tiles.length;a++){var b=gGameEngine.tiles[a];this==b&&gGameEngine.tiles.splice(a,1)}}}),Fire=Entity.extend({position:{},size:{w:38,h:38},bmp:null,bomb:null,init:function(a,b){this.bomb=b;var c=new createjs.SpriteSheet({images:[gGameEngine.fireImg],frames:{width:this.size.w,height:this.size.h,regX:0,regY:0},animations:{idle:[0,5,null,.4]}});this.bmp=new createjs.Sprite(c),this.bmp.gotoAndPlay("idle");var d=this;this.bmp.addEventListener("animationend",function(){d.remove()}),this.position=a;var e=Utils.convertToBitmapPosition(a);this.bmp.x=e.x+2,this.bmp.y=e.y-5,gGameEngine.stage.addChild(this.bmp)},update:function(){},remove:function(){this.bomb.explodeListener&&(this.bomb.explodeListener(),this.bomb.explodeListener=null),gGameEngine.stage.removeChild(this.bmp);for(var a=0;a<this.bomb.fires.length;a++){var b=this.bomb.fires[a];this==b&&this.bomb.fires.splice(a,1)}for(var a=0;a<gGameEngine.bombs.length;a++){var c=gGameEngine.bombs[a];this.bomb==c&&gGameEngine.bombs.splice(a,1)}}}),Bomb=Entity.extend({position:{},strength:1,size:{w:28,h:28},bmp:null,timer:0,timerMax:2,exploded:!1,fires:[],explodeListener:null,init:function(a,b){this.strength=b;var c=new createjs.SpriteSheet({images:[gGameEngine.bombImg],frames:{width:this.size.w,height:this.size.h,regX:5,regY:5},animations:{idle:[0,4,"idle",.2]}});this.bmp=new createjs.Sprite(c),this.bmp.gotoAndPlay("idle"),this.position=a;var d=Utils.convertToBitmapPosition(a);this.bmp.x=d.x+this.size.w/4,this.bmp.y=d.y+this.size.h/4,this.fires=[];for(var e=gGameEngine.getPlayersAndBots(),f=0;f<e.length;f++){var g=e[f];Utils.comparePositions(g.position,this.position)&&(g.escapeBomb=this)}},update:function(){this.exploded||(this.timer++,this.timer>this.timerMax*createjs.Ticker.getMeasuredFPS()&&this.explode())},explode:function(){if(this.exploded=!0,!gGameEngine.mute&&gGameEngine.soundtrackPlaying){var a=createjs.Sound.play("bomb");a.setVolume(.2)}for(var b=this.getDangerPositions(),c=0;c<b.length;c++){var d=b[c];this.fire(d);var e=gGameEngine.getTileMaterial(d);if("wood"==e){var f=gGameEngine.getTile(d);f.remove()}else if("grass"==e)for(var g=0;g<gGameEngine.bombs.length;g++){var h=gGameEngine.bombs[g];!h.exploded&&Utils.comparePositions(h.position,d)&&h.explode()}}this.remove()},getDangerPositions:function(){var a=[];a.push(this.position);for(var b=0;4>b;b++){var c,d;0==b?(c=1,d=0):1==b?(c=-1,d=0):2==b?(c=0,d=1):3==b&&(c=0,d=-1);for(var e=1;e<=this.strength;e++){var f=!0,g=!1,h={x:this.position.x+e*c,y:this.position.y+e*d},i=gGameEngine.getTileMaterial(h);if("wall"==i?(f=!1,g=!0):"wood"==i&&(f=!0,g=!0),f&&a.push(h),g)break}}return a},fire:function(a){var b=new Fire(a,this);this.fires.push(b)},remove:function(){gGameEngine.stage.removeChild(this.bmp)},setExplodeListener:function(a){this.explodeListener=a}}),Menu=Class.extend({visible:!0,views:[],init:function(){gGameEngine.botsCount=4,gGameEngine.playersCount=0,this.showLoader()},show:function(a){this.visible=!0,this.draw(a)},hide:function(){this.visible=!1;for(var a=0;a<this.views.length;a++)gGameEngine.stage.removeChild(this.views[a]);this.views=[]},update:function(){if(this.visible)for(var a=0;a<this.views.length;a++)gGameEngine.moveToFront(this.views[a])},setHandCursor:function(a){a.addEventListener("mouseover",function(){document.body.style.cursor="pointer"}),a.addEventListener("mouseout",function(){document.body.style.cursor="auto"})},setMode:function(a){this.hide(),"single"==a?(gGameEngine.botsCount=3,gGameEngine.playersCount=1):(gGameEngine.botsCount=2,gGameEngine.playersCount=2),gGameEngine.playing=!0,gGameEngine.restart()},draw:function(a){var b=this,c=(new createjs.Graphics).beginFill("rgba(0, 0, 0, 0.5)").drawRect(0,0,gGameEngine.size.w,gGameEngine.size.h),d=new createjs.Shape(c);gGameEngine.stage.addChild(d),this.views.push(d),a=a||[{text:"Bomber",color:"#ffffff"},{text:"girl",color:"#ff4444"}];var e=new createjs.Text(a[0].text,"bold 35px Helvetica",a[0].color),f=new createjs.Text(a[1].text,"bold 35px Helvetica",a[1].color),g=e.getMeasuredWidth()+f.getMeasuredWidth();e.x=gGameEngine.size.w/2-g/2,e.y=gGameEngine.size.h/2-e.getMeasuredHeight()/2-80,gGameEngine.stage.addChild(e),this.views.push(e),f.x=e.x+e.getMeasuredWidth(),f.y=gGameEngine.size.h/2-e.getMeasuredHeight()/2-80,gGameEngine.stage.addChild(f),this.views.push(f);var h=110,i=20,j=e.y+e.getMeasuredHeight()+40,k=gGameEngine.size.w/2-h-i,l=(new createjs.Graphics).beginFill("rgba(0, 0, 0, 0.5)").drawRect(k,j,h,h),m=new createjs.Shape(l);gGameEngine.stage.addChild(m),this.views.push(m),this.setHandCursor(m),m.addEventListener("click",function(){b.setMode("single")});var n=new createjs.Text("single","16px Helvetica","#ff4444"),o=new createjs.Text("player","16px Helvetica","#ffffff"),p=n.getMeasuredWidth()+o.getMeasuredWidth(),q=j+h-n.getMeasuredHeight()-20;n.x=k+(h-p)/2,n.y=q,gGameEngine.stage.addChild(n),this.views.push(n),o.x=n.x+n.getMeasuredWidth(),o.y=q,gGameEngine.stage.addChild(o),this.views.push(o);var r=j+13,s=new createjs.Bitmap("assets/img/betty.png");s.sourceRect=new createjs.Rectangle(0,0,48,48),s.x=k+(h-48)/2,s.y=r,gGameEngine.stage.addChild(s),this.views.push(s);var t=gGameEngine.size.w/2+i,u=(new createjs.Graphics).beginFill("rgba(0, 0, 0, 0.5)").drawRect(t,j,h,h),v=new createjs.Shape(u);gGameEngine.stage.addChild(v),this.views.push(v),this.setHandCursor(v),v.addEventListener("click",function(){b.setMode("multi")});var w=new createjs.Text("multi","16px Helvetica","#99cc00"),x=new createjs.Text("player","16px Helvetica","#ffffff"),y=w.getMeasuredWidth()+x.getMeasuredWidth();w.x=t+(h-y)/2,w.y=q,gGameEngine.stage.addChild(w),this.views.push(w),x.x=w.x+w.getMeasuredWidth(),x.y=q,gGameEngine.stage.addChild(x),this.views.push(x);var z=new createjs.Bitmap("assets/img/betty.png");z.sourceRect=new createjs.Rectangle(0,0,48,48),z.x=t+(h-48)/2-24+8,z.y=r,gGameEngine.stage.addChild(z),this.views.push(z);var A=new createjs.Bitmap("assets/img/betty2.png");A.sourceRect=new createjs.Rectangle(0,0,48,48),A.x=t+(h-48)/2+24-8,A.y=r,gGameEngine.stage.addChild(A),this.views.push(A)},showLoader:function(){var a=(new createjs.Graphics).beginFill("#000000").drawRect(0,0,gGameEngine.size.w,gGameEngine.size.h),b=new createjs.Shape(a);gGameEngine.stage.addChild(b);var c=new createjs.Text("Loading...","20px Helvetica","#FFFFFF");c.x=gGameEngine.size.w/2-c.getMeasuredWidth()/2,c.y=gGameEngine.size.h/2-c.getMeasuredHeight()/2,gGameEngine.stage.addChild(c),gGameEngine.stage.update()}}),InputEngine=Class.extend({bindings:{},actions:{},listeners:[],init:function(){},setup:function(){this.bind(38,"up"),this.bind(37,"left"),this.bind(40,"down"),this.bind(39,"right"),this.bind(32,"bomb"),this.bind(18,"bomb"),this.bind(87,"up2"),this.bind(65,"left2"),this.bind(83,"down2"),this.bind(68,"right2"),this.bind(16,"bomb2"),this.bind(13,"restart"),this.bind(27,"escape"),this.bind(77,"mute"),document.addEventListener("keydown",this.onKeyDown),document.addEventListener("keyup",this.onKeyUp)},onKeyDown:function(a){var b=gInputEngine.bindings[a.keyCode];return b&&(gInputEngine.actions[b]=!0,a.preventDefault()),!1},onKeyUp:function(a){var b=gInputEngine.bindings[a.keyCode];if(b){gInputEngine.actions[b]=!1;var c=gInputEngine.listeners[b];if(c)for(var d=0;d<c.length;d++){var e=c[d];e()}a.preventDefault()}return!1},bind:function(a,b){this.bindings[a]=b},addListener:function(a,b){this.listeners[a]=this.listeners[a]||new Array,this.listeners[a].push(b)},removeAllListeners:function(){this.listeners=[]}}),gInputEngine=new InputEngine,GameEngine=Class.extend({tileSize:32,tilesX:17,tilesY:13,size:{},fps:50,botsCount:2,playersCount:2,bonusesPercent:16,stage:null,menu:null,players:[],bots:[],tiles:[],bombs:[],bonuses:[],playerBoyImg:null,playerGirlImg:null,playerGirl2Img:null,tilesImgs:{},bombImg:null,fireImg:null,bonusesImg:null,playing:!1,mute:!1,soundtrackLoaded:!1,soundtrackPlaying:!1,soundtrack:null,init:function(){this.size={w:this.tileSize*this.tilesX,h:this.tileSize*this.tilesY}},load:function(){this.stage=new createjs.Stage("canvas"),this.stage.enableMouseOver();var a=new createjs.LoadQueue,b=this;a.addEventListener("complete",function(){b.playerBoyImg=a.getResult("playerBoy"),b.playerGirlImg=a.getResult("playerGirl"),b.playerGirl2Img=a.getResult("playerGirl2"),b.tilesImgs.grass=a.getResult("tile_grass"),b.tilesImgs.wall=a.getResult("tile_wall"),b.tilesImgs.wood=a.getResult("tile_wood"),b.bombImg=a.getResult("bomb"),b.fireImg=a.getResult("fire"),b.bonusesImg=a.getResult("bonuses"),b.setup()}),a.loadManifest([{id:"playerBoy",src:"assets/img/george.png"},{id:"playerGirl",src:"assets/img/betty.png"},{id:"playerGirl2",src:"assets/img/betty2.png"},{id:"tile_grass",src:"assets/img/tile_grass.png"},{id:"tile_wall",src:"assets/img/tile_wall.png"},{id:"tile_wood",src:"assets/img/tile_wood.png"},{id:"bomb",src:"assets/img/bomb.png"},{id:"fire",src:"assets/img/fire.png"},{id:"bonuses",src:"assets/img/bonuses.png"}]),createjs.Sound.addEventListener("fileload",this.onSoundLoaded),createjs.Sound.alternateExtensions=["mp3"],createjs.Sound.registerSound("assets/sound/bomb.ogg","bomb"),createjs.Sound.registerSound("assets/sound/game.ogg","game"),this.menu=new Menu},setup:function(){gInputEngine.bindings.length||gInputEngine.setup(),this.bombs=[],this.tiles=[],this.bonuses=[],this.drawTiles(),this.drawBonuses(),this.spawnBots(),this.spawnPlayers(),gInputEngine.addListener("mute",this.toggleSound),setTimeout(function(){gInputEngine.addListener("restart",function(){0==gGameEngine.playersCount?gGameEngine.menu.setMode("single"):(gGameEngine.menu.hide(),gGameEngine.restart())})},200),gInputEngine.addListener("escape",function(){gGameEngine.menu.visible||gGameEngine.menu.show()}),createjs.Ticker.hasEventListener("tick")||(createjs.Ticker.addEventListener("tick",gGameEngine.update),createjs.Ticker.setFPS(this.fps)),gGameEngine.playersCount>0&&this.soundtrackLoaded&&this.playSoundtrack(),this.playing||this.menu.show()},onSoundLoaded:function(a){"game"==a.id&&(gGameEngine.soundtrackLoaded=!0,gGameEngine.playersCount>0&&gGameEngine.playSoundtrack())},playSoundtrack:function(){gGameEngine.soundtrackPlaying||(gGameEngine.soundtrack=createjs.Sound.play("game","none",0,0,-1),gGameEngine.soundtrack.setVolume(1),gGameEngine.soundtrackPlaying=!0)},update:function(){for(var a=0;a<gGameEngine.players.length;a++){var b=gGameEngine.players[a];b.update()}for(var a=0;a<gGameEngine.bots.length;a++){var c=gGameEngine.bots[a];c.update()}for(var a=0;a<gGameEngine.bombs.length;a++){var d=gGameEngine.bombs[a];d.update()}gGameEngine.menu.update(),gGameEngine.stage.update()},drawTiles:function(){for(var a=0;a<this.tilesY;a++)for(var b=0;b<this.tilesX;b++)if(0==a||0==b||a==this.tilesY-1||b==this.tilesX-1||b%2==0&&a%2==0){var c=new Tile("wall",{x:b,y:a});this.stage.addChild(c.bmp),this.tiles.push(c)}else{var c=new Tile("grass",{x:b,y:a});if(this.stage.addChild(c.bmp),!(2>=a&&2>=b||a>=this.tilesY-3&&b>=this.tilesX-3||2>=a&&b>=this.tilesX-3||a>=this.tilesY-3&&2>=b)){var d=new Tile("wood",{x:b,y:a});this.stage.addChild(d.bmp),this.tiles.push(d)}}},drawBonuses:function(){for(var a=[],b=0;b<this.tiles.length;b++){var c=this.tiles[b];"wood"==c.material&&a.push(c)}a.sort(function(){return.5-Math.random()});for(var d=0;4>d;d++)for(var e=Math.round(a.length*this.bonusesPercent*.01/4),f=0,b=0;b<a.length&&!(f>e);b++){var c=a[b];if(0==d&&c.position.x<this.tilesX/2&&c.position.y<this.tilesY/2||1==d&&c.position.x<this.tilesX/2&&c.position.y>this.tilesY/2||2==d&&c.position.x>this.tilesX/2&&c.position.y<this.tilesX/2||3==d&&c.position.x>this.tilesX/2&&c.position.y>this.tilesX/2){var g=f%3,h=new Bonus(c.position,g);this.bonuses.push(h),this.moveToFront(c.bmp),f++}}},spawnBots:function(){if(this.bots=[],this.botsCount>=1){var a=new Bot({x:1,y:this.tilesY-2});this.bots.push(a)}if(this.botsCount>=2){var b=new Bot({x:this.tilesX-2,y:1});this.bots.push(b)}if(this.botsCount>=3){var c=new Bot({x:this.tilesX-2,y:this.tilesY-2});this.bots.push(c)}if(this.botsCount>=4){var c=new Bot({x:1,y:1});this.bots.push(c)}},spawnPlayers:function(){if(this.players=[],this.playersCount>=1){var a=new Player({x:1,y:1});this.players.push(a)}if(this.playersCount>=2){var b={up:"up2",left:"left2",down:"down2",right:"right2",bomb:"bomb2"},c=new Player({x:this.tilesX-2,y:this.tilesY-2},b,1);this.players.push(c)}},intersectRect:function(a,b){return a.left<=b.right&&b.left<=a.right&&a.top<=b.bottom&&b.top<=a.bottom},getTile:function(a){for(var b=0;b<this.tiles.length;b++){var c=this.tiles[b];if(c.position.x==a.x&&c.position.y==a.y)return c}},getTileMaterial:function(a){var b=this.getTile(a);return b?b.material:"grass"},gameOver:function(a){if(!gGameEngine.menu.visible)if("win"==a){var b="You won!";if(gGameEngine.playersCount>1){var c=gGameEngine.getWinner();b=0==c?"Player 1 won!":"Player 2 won!"}this.menu.show([{text:b,color:"#669900"},{text:" ;D",color:"#99CC00"}])}else this.menu.show([{text:"Game Over",color:"#CC0000"},{text:" :(",color:"#FF4444"}])},getWinner:function(){for(var a=0;a<gGameEngine.players.length;a++){var b=gGameEngine.players[a];if(b.alive)return a}},restart:function(){gInputEngine.removeAllListeners(),gGameEngine.stage.removeAllChildren(),gGameEngine.setup()},moveToFront:function(a){var b=gGameEngine.stage.getNumChildren();gGameEngine.stage.setChildIndex(a,b-1)},toggleSound:function(){gGameEngine.mute?(gGameEngine.mute=!1,gGameEngine.soundtrack.resume()):(gGameEngine.mute=!0,gGameEngine.soundtrack.pause())},countPlayersAlive:function(){for(var a=0,b=0;b<gGameEngine.players.length;b++)gGameEngine.players[b].alive&&a++;return a},getPlayersAndBots:function(){for(var a=[],b=0;b<gGameEngine.players.length;b++)a.push(gGameEngine.players[b]);for(var b=0;b<gGameEngine.bots.length;b++)a.push(gGameEngine.bots[b]);return a}}),gGameEngine=new GameEngine;